{"version":3,"sources":["../src/routes.js"],"names":["String","prototype","hashCode","hash","i","chr","length","charCodeAt","getBaseUrl","req","protocol","get","upload","storage","multer","memoryStorage","app","post","single","res","console","log","mimetype","buffer","file","doc","no","params","buf","json","render","title","subtitle","baseUrl","pageno","parseInt","query","pagesize","isNaN","contactlist","jsonp","contact","toObject","next","name","err","Error","status","contacts","body","tel","address","put","delete","setHeader","end","image","use","message"],"mappings":"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","file":"routes.js","sourcesContent":["import multer from 'multer';\nimport sleep from 'system-sleep';\nimport { changePhoto, getPhotoImage, batchInsertContacts, contactsAll, contactOne, searchContact, insertContact, updateContact, deleteContact } from './db';\n\n\nString.prototype.hashCode = function() {\n  var hash = 0, i, chr;\n  if (this.length === 0) return hash;\n  for (i = 0; i < this.length; i++) {\n    chr   = this.charCodeAt(i);\n    hash  = ((hash << 5) - hash) + chr;\n    hash |= 0;\n  }\n  return hash;\n};\n\nconst getBaseUrl = (req) => req.protocol + \"://\" + req.get('host')\nconst upload = multer({ storage : multer.memoryStorage()});\n\nexport default (app) => { \n\n    app.post('/contacts/:no/photo', upload.single('photo'), async (req, res) => {\n        console.log(\"### POST /contacts/:no/photo\");\n        const { mimetype, buffer } = req.file;\n        let doc = await changePhoto({ no:req.params.no, buf:buffer, mimetype })\n        res.json(doc);\n    });\n\n    app.get('/', (req, res) => {\n        console.log(\"### GET /\");\n        res.render('index', {\n             title: '연락처서비스 v2.0',\n             subtitle : '(node.js + express + mongodb)'\n        })\n    });\n\n    app.get('/contacts', async (req, res) => {\n        console.log(\"### GET /contacts\");\n        const baseUrl = getBaseUrl(req);\n        let pageno = parseInt(req.query.pageno);\n        let pagesize = parseInt(req.query.pagesize);\n        if (isNaN(pageno)) pageno=0;\n        if (isNaN(pagesize)) pagesize=5;\n        if (pageno==0)  pagesize = 0;\n\n        const contactlist = await contactsAll({ pageno:pageno, pagesize:pagesize, baseUrl:baseUrl })\n        res.jsonp(contactlist);\n    });\n\n    app.get('/contacts_long', async (req, res) => {\n        console.log(\"### GET /contacts_long\");\n        sleep(1000);\n        const baseUrl = getBaseUrl(req);\n        let pageno = parseInt(req.query.pageno);\n        let pagesize = parseInt(req.query.pagesize);\n        if (isNaN(pageno)) pageno=0;\n        if (isNaN(pagesize)) pagesize=5;\n        if (pageno==0)  pagesize = 0;\n\n        const contactlist = await contactsAll({ pageno:pageno, pagesize:pagesize, baseUrl:baseUrl })\n        res.jsonp(contactlist);\n    });\n\n    app.get('/contacts/:no', async (req,res) => {\n        console.log(\"### GET /contacts/:no\");\n        const baseUrl = getBaseUrl(req);\n        const no = req.params.no;\n        const contact = await contactOne({ no:no, baseUrl });\n        if (contact.toObject)\n            res.jsonp(contact.toObject());\n        else \n            res.jsonp(contact)\n    });\n\n    app.get('/contacts/search/:name', async (req,res,next) => {\n        const name = req.params.name;\n        if (typeof(name) !== \"string\" || name.length < 2) {\n            var err = new Error(\"두글자 이상의 이름을 입력하세요\");\n            err.status = 400;\n            next(err);\n        }\n        console.log(\"### GET /contacts/search/:name\")\n        const baseUrl = getBaseUrl(req);\n        const contacts = await searchContact({ name, baseUrl })\n        res.jsonp(contacts);\n    });\n\n    app.get('/contacts_long/search/:name', async (req,res, next) => {\n        const name = req.params.name;\n        if (typeof(name) !== \"string\" || name.length < 2) {\n            var err = new Error(\"두글자 이상의 이름을 입력하세요\");\n            err.status = 400;\n            next(err);\n        }\n        sleep(1000);\n        console.log(\"### GET /contacts/search/:name\")\n        const baseUrl = getBaseUrl(req);\n        const contacts = await searchContact({ name, baseUrl })\n        res.jsonp(contacts);\n    });\n\n    app.post('/contacts', async (req,res) => {\n        console.log(\"### POST /contacts\");\n        let name = req.body.name;\n        let tel = req.body.tel;\n        let address = req.body.address;\n\n        const doc = await insertContact({ name, tel, address })\n        res.jsonp(doc);\n    });\n\n    app.put('/contacts/:no', async (req,res) => {\n        console.log(\"### PUT /contacts/:no\");\n        var no = req.params.no;\n        var name = req.body.name;\n        var tel = req.body.tel;\n        var address = req.body.address;\n\n        const doc = await updateContact({ no, name, tel, address });\n        res.jsonp(doc);\n    });\n\n    app.delete('/contacts/:no', async (req,res) => {\n        console.log(\"### DELETE /contacts/:no\");\n        var no = req.params.no\n        const doc = await deleteContact({ no })\n        res.jsonp(doc);\n    });\n\n    app.post('/contacts/batchinsert', async (req,res) => {\n        console.log(\"### POST /contacts/batchinsert\");\n        let contacts = req.body;\n        const doc = await batchInsertContacts({ contacts: contacts })\n        res.jsonp(doc);\n    });\n\n    app.get('/photos/:no', async (req,res, )=> {\n        let doc = await getPhotoImage({ no: req.params.no });\n        if (doc) {\n          res.setHeader('Content-Type', doc.mimetype);\n          res.end(doc.image);\n        } else {\n          res.status(404);\n          res.end();\n        }\n    })\n\n    //----에러 처리 시작\n    app.get('*', (req, res, next) => {\n        var err = new Error();\n        err.status = 404;\n        next(err);\n    });\n \n    app.use((err, req, res, next) => {\n        console.log(\"### ERROR!!\")\n        if(err.status === 404) {\n            res.status(404).jsonp({ status:404, message:\"잘못된 URI 요청\"});\n        } else if (err.status === 500) {\n            res.status(500).jsonp({ status:500, message:\"내부 서버 오류\"});\n        } else {\n            res.status(err.status).jsonp({ status:\"fail\", message:err.message });\n        }\n    });\n}\n\n"]}